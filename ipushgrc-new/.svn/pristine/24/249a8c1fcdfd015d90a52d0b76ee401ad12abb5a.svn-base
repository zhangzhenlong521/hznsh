package com.pushworld.ipushgrc.ui.icheck.p040;

import java.awt.Dimension;
import java.awt.Insets;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.io.File;
import java.io.FileOutputStream;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.Map;

import javax.swing.AbstractAction;
import javax.swing.JFileChooser;
import javax.swing.JMenuItem;
import javax.swing.JPopupMenu;
import javax.swing.ListSelectionModel;

import org.apache.poi.hssf.usermodel.HSSFCell;
import org.apache.poi.hssf.usermodel.HSSFCellStyle;
import org.apache.poi.hssf.usermodel.HSSFFont;
import org.apache.poi.hssf.usermodel.HSSFRow;
import org.apache.poi.hssf.usermodel.HSSFSheet;
import org.apache.poi.hssf.usermodel.HSSFWorkbook;
import org.apache.poi.hssf.util.Region;

import cn.com.infostrategy.to.common.HashVO;
import cn.com.infostrategy.to.common.HashVOStruct;
import cn.com.infostrategy.to.common.TBUtil;
import cn.com.infostrategy.to.common.WLTConstants;
import cn.com.infostrategy.to.common.WLTRemoteException;
import cn.com.infostrategy.to.mdata.BillVO;
import cn.com.infostrategy.to.mdata.InsertSQLBuilder;
import cn.com.infostrategy.to.mdata.UpdateSQLBuilder;
import cn.com.infostrategy.ui.common.AbstractWorkPanel;
import cn.com.infostrategy.ui.common.ClientEnvironment;
import cn.com.infostrategy.ui.common.MessageBox;
import cn.com.infostrategy.ui.common.SplashWindow;
import cn.com.infostrategy.ui.common.UIUtil;
import cn.com.infostrategy.ui.common.WLTButton;
import cn.com.infostrategy.ui.common.WLTSplitPane;
import cn.com.infostrategy.ui.mdata.BillCardDialog;
import cn.com.infostrategy.ui.mdata.BillCardPanel;
import cn.com.infostrategy.ui.mdata.BillListDialog;
import cn.com.infostrategy.ui.mdata.BillListHtmlHrefEvent;
import cn.com.infostrategy.ui.mdata.BillListHtmlHrefListener;
import cn.com.infostrategy.ui.mdata.BillListPanel;
import cn.com.infostrategy.ui.mdata.BillListSelectListener;
import cn.com.infostrategy.ui.mdata.BillListSelectionEvent;

import com.pushworld.ipushgrc.ui.icheck.p080.ZZLUIUtil;
import com.pushworld.ipushgrc.ui.icheck.word.WordExport;

/**
 * 网络版检查实施【邵春芸/2016-08-19】
 * @author shaochunyun
 *
 */
public class CheckImplementWKPanel extends AbstractWorkPanel implements BillListSelectListener, ActionListener, BillListHtmlHrefListener {

	private BillListPanel schemeList = null; //检查方案
	private BillListPanel implList = null; //检查实施主表
	private BillListPanel itemList = null; //检查实施子表
	private WLTButton btn_selectScheme;//检查方案-切换方案【李春娟/2016-08-19】
	private WLTButton btn_copy;//检查实施新增（拷贝）【李春娟/2016-09-29】
	private WLTButton btn_edit;//检查实施编辑【李春娟/2016-09-29】
	private WLTButton btn_relate;//检查实施关联客户【李春娟/2016-10-09】
	private WLTButton btn_change_data;//检查方案-数据交换【李春娟/2016-08-30】
	private WLTButton btn_insert;//检查实施子表-逐条录入
	private WLTButton btn_query;//检查实施子表-检查评价指引
	private WLTButton btn_end;//检查实施子表-底稿录入完成
	private WLTButton btn_deletePro;//问题列表-删除按钮【李春娟/2016-09-07】
	private WLTButton btn_exp_word;//网络版导出检查通知书、进驻会谈记录模板、资料调阅清单【张珍龙/2016-09-21】
	private String schemeTempletCode = "V_CK_SCHEME_LCJ_Q01";
	private String parentTempletCode = "CK_SCHEME_IMPL_E01";//以前检查实施只有一张表，修改为将检查实施弄成主子表关系【李春娟/2016-09-23】
	private String parentTempletCode2 = "CK_SCHEME_IMPL_E02";//信贷检查和票据检查的模板和一般检查不同【李春娟/2016-10-09】
	private String childTempletCode = "V_CK_SCHEME_IMPLEMENT_SCY_E01"; //检查详细底稿模板code 
	private String ProblemTempCode = "CK_PROBLEM_INFO_SCY_E01";
	private String loginUserid = ClientEnvironment.getInstance().getLoginUserID();
	private JPopupMenu changeDataPopMenu, expWordPopMenu;//检查方案-数据交换，检查方案-导出Word
	private JMenuItem menu_impdata, menu_expdata, menu_notice, menu_interview, menu_retrival;//数据交换-导入，数据交换-导出，导出Word-导出检查通知书，导出Word-导出进驻会谈记录模板，导出Word-导出资料调阅清单
	private WLTSplitPane splitPane2;

	@Override
	public void initialize() {
		String[][] schemes = null;
		try {
			schemes = UIUtil.getStringArrayByDS(null, "select id,SCHEMETYPE from ck_scheme where id in (select schemeid from ck_scheme_user where userid=" + loginUserid + ")");
		} catch (WLTRemoteException e1) {
			e1.printStackTrace();
		} catch (Exception e1) {
			e1.printStackTrace();
		}
		boolean isXDJC = false;
		String schemeid = null;
		if (schemes != null && schemes.length > 0) {
			schemeid = schemes[0][0];
			String SCHEMETYPE = schemes[0][1];
			if ("信贷检查".equals(SCHEMETYPE) || "票据检查".equals(SCHEMETYPE)) {//信贷检查和票据检查单个业务需要检查多笔【李春娟/2016-09-29】
				isXDJC = true;
			}
		}

		btn_selectScheme = new WLTButton("切换方案", "office_051.gif");
		btn_exp_word = new WLTButton("导出Word");
		btn_change_data = new WLTButton("数据交换");//【李春娟/2016-08-30】

		btn_copy = new WLTButton("新增");//【李春娟/2016-09-29】
		btn_edit = new WLTButton("修改");//【李春娟/2016-09-29】
		btn_relate = new WLTButton("关联");

		btn_selectScheme.addActionListener(this);
		btn_exp_word.addActionListener(this);
		btn_change_data.addActionListener(this);

		btn_copy.addActionListener(this);
		btn_edit.addActionListener(this);
		btn_relate.addActionListener(this);

		//检查方案
		schemeList = new BillListPanel(schemeTempletCode);
		schemeList.setQuickQueryPanelVisiable(false);
		schemeList.addBatchBillListButton(new WLTButton[] { btn_selectScheme, btn_exp_word, btn_change_data });
		schemeList.repaintBillListButton();
		schemeList.addBillListSelectListener(this);

		//检查实施子表
		itemList = new BillListPanel(childTempletCode);
		btn_insert = new WLTButton("逐条录入", "folder_edit.png");
		btn_query = new WLTButton("检查评价指引");
		btn_end = new WLTButton("底稿录入完成");

		btn_insert.addActionListener(this);
		btn_query.addActionListener(this);
		btn_end.addActionListener(this);

		itemList.addBatchBillListButton(new WLTButton[] { btn_insert, btn_query, btn_end });
		itemList.repaintBillListButton();
		itemList.addBillListHtmlHrefListener(this);

		if (isXDJC) {
			implList = new BillListPanel(parentTempletCode2);
			implList.addBatchBillListButton(new WLTButton[] { btn_copy, btn_edit, btn_relate });
			implList.repaintBillListButton();
			if (schemeid != null) {
				schemeList.QueryDataByCondition("schemeid='" + schemeid + "' and (teamusers like '%;" + loginUserid + ";%' or leader2='" + loginUserid + "' or leader ='" + loginUserid + "' or referee like '%;" + loginUserid + ";%')");
			}
			WLTSplitPane splitPane = new WLTSplitPane(WLTSplitPane.HORIZONTAL_SPLIT, schemeList, implList);
			splitPane.setDividerLocation(540);//修改分隔条位置【李春娟/2016-10-09】

			splitPane2 = new WLTSplitPane(WLTSplitPane.VERTICAL_SPLIT, splitPane, itemList);
			splitPane2.setDividerLocation(250);//修改分隔条位置【李春娟/2016-10-09】
		} else {
			implList = new BillListPanel(parentTempletCode);
			implList.addBatchBillListButton(new WLTButton[] { btn_selectScheme, btn_exp_word, btn_change_data });
			implList.repaintBillListButton();
			if (schemeid != null) {
				implList.QueryDataByCondition("schemeid='" + schemeid + "' and (teamusers like '%;" + loginUserid + ";%' or leader2='" + loginUserid + "' or leader ='" + loginUserid + "' or referee like '%;" + loginUserid + ";%')");
			}
			splitPane2 = new WLTSplitPane(WLTSplitPane.VERTICAL_SPLIT, implList, itemList);
			splitPane2.setDividerLocation(250);//修改分隔条位置【李春娟/2016-10-09】
		}
		implList.addBillListSelectListener(this);
		implList.setQuickQueryPanelVisiable(false);//设置查询面板隐藏【李春娟/2016-09-27】

		this.add(splitPane2);
	}

	/**
	 * 列表选择事件
	 */
	public void onBillListSelectChanged(BillListSelectionEvent event) {
		if (event.getBillListPanel() == implList) {
			BillVO vo = implList.getSelectedBillVO();
			if (null != vo) {
				String implid = vo.getStringValue("id");
				String status = vo.getStringValue("status");
				itemList.QueryDataByCondition("implid = '" + implid + "'");
				if ("已结束".equals(status)) {
					btn_edit.setVisible(false);//检查实施-修改
					btn_insert.setVisible(false);//检查实施子表-逐条录入
					btn_end.setVisible(false);//检查实施子表-底稿录入完成
				} else {
					btn_edit.setVisible(true);
					btn_insert.setVisible(true);
					btn_end.setVisible(true);
				}
			}
		} else if (event.getBillListPanel() == schemeList) {
			BillVO vo = schemeList.getSelectedBillVO();
			if (null != vo) {
				String schemeid = vo.getStringValue("schemeid");
				String deptid = vo.getStringValue("deptid");
				implList.QueryDataByCondition("schemeid = '" + schemeid + "' and deptid = '" + deptid + "'");
				itemList.clearTable();
			}
		}
	}

	/**
	 * 问题列表 链接点击事件
	 */
	public void onBillListHtmlHrefClicked(BillListHtmlHrefEvent arg0) {
		ArrayList<String> al_sql = new ArrayList<String>();
		String[] sql = itemList.getUpdateSQLs();
		for (int i = 0; i < sql.length; i++) {
			al_sql.add(sql[i].substring(0, sql[i].indexOf("where")) + "  where id='" + itemList.getAllBillVOs()[i].getStringValue("id") + "'");

		}

		try {
			UIUtil.executeBatchByDS(null, al_sql);
		} catch (Exception e) {
			e.printStackTrace();
		}

		// 控制缺陷显示
		final BillListDialog list_dialog = new BillListDialog(this, "问题录入", ProblemTempCode, 1000, 500);
		BillListPanel bugListPanel = list_dialog.getBilllistPanel(); //缺陷记录表
		BillVO billvo = implList.getSelectedBillVO();
		if (billvo != null && !"已结束".equals(billvo.getStringValue("status"))) {
			btn_deletePro = new WLTButton("删除");//问题删除，需要同时删除违规事件【李春娟/2016-09-07】
			btn_deletePro.addActionListener(this);
			bugListPanel.addBillListButton(WLTButton.createButtonByType(WLTButton.LIST_POPEDIT)); //编辑
			bugListPanel.addBillListButton(btn_deletePro); //删除
		}
		bugListPanel.addBillListButton(WLTButton.createButtonByType(WLTButton.LIST_SHOWCARD)); //
		bugListPanel.repaintBillListButton();
		list_dialog.setTitle(itemList.getSelectedBillVO().getStringValue("name"));
		list_dialog.getBtn_confirm().setVisible(false);
		list_dialog.getBtn_cancel().setText("关闭");
		list_dialog.getBtn_cancel().setIcon(UIUtil.getImage("zt_031.gif"));// zt_050.gif  office_187.gif
		list_dialog.getBtn_cancel().setMargin(new Insets(0, 0, 0, 0)); //
		list_dialog.getBtn_cancel().setPreferredSize(new Dimension(80, list_dialog.getBtn_cancel().BTN_HEIGHT));
		list_dialog.getBilllistPanel().QueryDataByCondition("parentid='" + arg0.getBillListPanel().getSelectedBillVO().getStringValue("id") + "'");
		list_dialog.setVisible(true);
		itemList.refreshCurrSelectedRow();
	}

	/**
	 * 按钮事件
	 */
	public void actionPerformed(ActionEvent e) {
		if (e.getSource() == btn_selectScheme) {//检查方案-切换方案
			onSelectScheme();
		} else if (e.getSource() == btn_change_data) {//检查方案-数据交换
			onChangeData();
		} else if (e.getSource() == menu_impdata) {//检查方案-数据交换-导入【李春娟/2016-08-30】
			onImpData();
		} else if (e.getSource() == menu_expdata) {//检查方案-数据交换-导出【李春娟/2016-08-30】
			onExpData();
		} else if (e.getSource() == btn_exp_word) {//检查方案-导出Word
			onExpWord();
		} else if (e.getSource() == menu_notice) {//检查方案-导出Word-导出检查通知书
			new SplashWindow(this, new AbstractAction() {
				public void actionPerformed(ActionEvent e) {
					impnotice();
				}
			}, 600, 130, 300, 300, false); // 

		} else if (e.getSource() == menu_interview) {//检查方案-导出Word-导出进驻会谈记录模板
			new SplashWindow(this, new AbstractAction() {
				public void actionPerformed(ActionEvent e) {
					impinterview();
				}
			}, 600, 130, 300, 300, false); // 

		} else if (e.getSource() == menu_retrival) {//检查方案-导出Word-导出资料调阅清单
			new SplashWindow(this, new AbstractAction() {
				public void actionPerformed(ActionEvent e) {
					impRetrival();
				}
			}, 600, 130, 300, 300, false); // 

		} else if (e.getSource() == btn_copy) {//检查实施新增（拷贝）
			onCopyImpl();
		} else if (e.getSource() == btn_edit) {//检查实施编辑
			onEditImpl();
		} else if (e.getSource() == btn_relate) {//检查实施关联客户
			onRelate();
		} else if (e.getSource() == btn_insert) {//检查实施子表-逐条录入
			onInsert();
		} else if (e.getSource() == btn_query) {//检查实施子表-检查评价指引
			onCheckHelp();
		} else if (e.getSource() == btn_end) {//检查实施子表-底稿录入完成
			onEnd();
		} else if (e.getSource() == btn_deletePro) {//问题列表-删除
			onDeleteProblem();
		}
	}

	/**
	 * 切换方案【李春娟/2016-08-19】
	 */
	private void onSelectScheme() {
		BillListDialog listDialog = new BillListDialog(this, "请选择一个方案", "CK_SCHEME_LCJ_E01", 900, 500);
		listDialog.getBilllistPanel().setDataFilterCustCondition("id in (select schemeid from V_CK_SCHEME where (status='未执行' or status='执行中') and (teamusers like '%;" + loginUserid + ";%' or leader2='" + loginUserid + "' or leader ='" + loginUserid + "' or referee like '%;" + loginUserid + ";%'))");
		listDialog.getBilllistPanel().queryDataByCondition(null, "createdate,id desc");//按创建日期倒序排序
		listDialog.getBilllistPanel().setSelectionMode(ListSelectionModel.SINGLE_SELECTION);//设置只能选一行
		listDialog.setVisible(true);
		if (listDialog.getCloseType() == 1) {//如果选择了记录，点击确定按钮
			BillVO[] vos = listDialog.getReturnBillVOs();
			if (vos == null || vos.length == 0) {//一般情r，点击"确定"按钮后这里不为空
				MessageBox.show(this, "请选择一个方案.");
				return;
			} else {
				itemList.clearTable();
				String schemeid = vos[0].getStringValue("id");
				String SCHEMETYPE = vos[0].getStringValue("SCHEMETYPE");
				if ("信贷检查".equals(SCHEMETYPE) || "票据检查".equals(SCHEMETYPE)) {
					schemeList.QueryDataByCondition("schemeid='" + schemeid + "' and (teamusers like '%;" + loginUserid + ";%' or leader2='" + loginUserid + "' or leader ='" + loginUserid + "' or referee like '%;" + loginUserid + ";%')");
					if (parentTempletCode2.equalsIgnoreCase(implList.getTempletVO().getTempletcode())) {//如果已经是信贷检查模板
						implList.clearTable();
					} else {
						schemeList.addBatchBillListButton(new WLTButton[] { btn_selectScheme, btn_exp_word, btn_change_data });
						schemeList.repaintBillListButton();

						implList = new BillListPanel(parentTempletCode2);
						implList.addBillListSelectListener(this);
						implList.setQuickQueryPanelVisiable(false);//设置查询面板隐藏【李春娟/2016-09-27】
						implList.addBatchBillListButton(new WLTButton[] { btn_copy, btn_edit, btn_relate });
						implList.repaintBillListButton();
						WLTSplitPane splitPane = new WLTSplitPane(WLTSplitPane.HORIZONTAL_SPLIT, schemeList, implList);
						splitPane.setDividerLocation(540);//修改分隔条位置【李春娟/2016-08-24】

						splitPane2 = new WLTSplitPane(WLTSplitPane.VERTICAL_SPLIT, splitPane, itemList);
						splitPane2.setDividerLocation(250);//修改分隔条位置【李春娟/2016-08-24】
						this.removeAll();
						this.add(splitPane2);
						this.repaint();
					}
				} else {
					if (parentTempletCode2.equalsIgnoreCase(implList.getTempletVO().getTempletcode())) {//如果已经是信贷检查模板
						implList = new BillListPanel(parentTempletCode);
						implList.addBillListSelectListener(this);
						implList.setQuickQueryPanelVisiable(false);//设置查询面板隐藏【李春娟/2016-09-27】
						implList.addBatchBillListButton(new WLTButton[] { btn_selectScheme, btn_exp_word, btn_change_data });
						implList.repaintBillListButton();
						splitPane2 = new WLTSplitPane(WLTSplitPane.VERTICAL_SPLIT, implList, itemList);
						splitPane2.setDividerLocation(250);//修改分隔条位置【李春娟/2016-10-09】
						this.removeAll();
						this.add(splitPane2);
						this.repaint();
					}
					implList.QueryDataByCondition("schemeid='" + schemeid + "' and (teamusers like '%;" + loginUserid + ";%' or leader2='" + loginUserid + "' or leader ='" + loginUserid + "' or referee like '%;" + loginUserid + ";%')");
				}
				try {
					String count = UIUtil.getStringValueByDS(null, "select count(*) from ck_scheme_user where userid=" + loginUserid);
					if (count == null || "".equals(count) || "0".equals(count)) {
						InsertSQLBuilder sb = new InsertSQLBuilder("ck_scheme_user");
						sb.putFieldValue("id", UIUtil.getSequenceNextValByDS(null, "S_ck_scheme_user"));
						sb.putFieldValue("userid", loginUserid);
						sb.putFieldValue("schemeid", schemeid);//以前根据schemeid、deptid、userid记录，后来修改为根据schemeid记录【李春娟/2016-09-23】
						UIUtil.executeUpdateByDS(null, sb.getSQL());
					} else {
						UIUtil.executeUpdateByDS(null, "update ck_scheme_user set schemeid='" + schemeid + "' where userid =" + loginUserid);
					}
				} catch (WLTRemoteException e) {
					e.printStackTrace();
				} catch (Exception e) {
					e.printStackTrace();
				}
			}
		}
	}

	/**
	 * 检查方案-数据交换按钮弹出框
	 */
	private void onChangeData() {
		if (changeDataPopMenu == null) {
			changeDataPopMenu = new JPopupMenu(); //
			menu_impdata = new JMenuItem("导入");
			menu_expdata = new JMenuItem("导出");

			menu_impdata.addActionListener(this);
			menu_expdata.addActionListener(this);

			changeDataPopMenu.add(menu_impdata);
			changeDataPopMenu.add(menu_expdata);
		}
		if (btn_change_data.getMousePosition() == null) {//debug调试时这里经常为空，故判断一下【李春娟/2016-10-14】
			changeDataPopMenu.show(btn_change_data, 30, 20);
		} else {
			changeDataPopMenu.show(btn_change_data, btn_change_data.getMousePosition().x, btn_change_data.getMousePosition().y);
		}
	}

	/**
	 * 检查方案-数据交换-导入检查底稿【李春娟/2016-08-31】
	 */
	private void onImpData() {//ck_scheme_implement,ck_problem_info,cmp_event  单机版新增id  都弄成负值
		int i = new ICheckUIUtil().importDataByPackage(this, "导入检查底稿数据包", 0);
		if (i == 1) {
			if (implList.getRowCount() > 0) {
				implList.refreshData();
			} else {
				implList.clearTable();
			}
			itemList.clearTable();
			MessageBox.show(this, "底稿导入成功!");
		}
	}

	/**
	 * 检查方案-数据交换-导出检查底稿【李春娟/2016-08-30】
	 * 网络版导出某个方案某个单位的所有检查底稿
	 * 单机版导出可选择具体导出哪个检查底稿
	 * 网络版导出表：ck_scheme_impl,ck_scheme_implement,ck_scheme,ck_member_work,ck_manuscript_design,pub_user,pub_corp_dept,pub_post,pub_user_post,cmp_cmpfile,cmp_risk
	 * 单机版导出表：ck_scheme_impl,ck_scheme_implement,ck_problem_info,cmp_wardevent_cust,cmp_wardevent_user,cmp_event,ck_scheme,ck_member_work,ck_manuscript_design,ck_record
	 *
	 * 单机->网络版导入表：ck_scheme_impl（单机版可编辑或拷贝检查实施主表）,检查实施表（ck_scheme_implement）,问题表（ck_problem_info）,违规事件涉及客户（cmp_wardevent_cust）,违规事件涉及员工（cmp_wardevent_user）,违规事件表（cmp_event）,单机版导出通知书等工作量（ck_record）
	 * 单机->单机版导入表：ck_scheme_impl,ck_scheme_implement,ck_problem_info,cmp_wardevent_cust,cmp_wardevent_user,cmp_event,ck_scheme,ck_member_work,ck_manuscript_design,ck_record
	 *
	 */
	private void onExpData() {		
		BillListDialog listDialog = new BillListDialog(this, "请勾选需要导出的方案", "V_CK_SCHEME_IMPL_Q01", 950, 500);//网络版过滤相同的方案名和被检查机构【李春娟/2016-09-29】
		listDialog.getBilllistPanel().setRowNumberChecked(true);//设置勾选
		listDialog.getBilllistPanel().setDataFilterCustCondition("(teamusers like '%;" + loginUserid + ";%' or leader2='" + loginUserid + "' or leader ='" + loginUserid + "' or referee like '%;" + loginUserid + ";%')");
		listDialog.setVisible(true);
		if (listDialog.getCloseType() == 1) {//如果选择了记录，点击确定按钮
			final BillVO[] vos = listDialog.getBilllistPanel().getCheckedBillVOs();
			if (vos == null || vos.length == 0) {//一般情r，点击"确定"按钮后这里不为空
				MessageBox.show(this, "请至少勾选一个方案.");
				return;
			} else {
				JFileChooser chooser = new JFileChooser();
				chooser.setDialogTitle("请选择存放目录");
				chooser.setFileSelectionMode(JFileChooser.DIRECTORIES_ONLY);
				int flag = chooser.showSaveDialog(this);
				if (flag == 1 || chooser.getSelectedFile() == null) {
					return;
				}
				final String str_path = chooser.getSelectedFile().getAbsolutePath(); //
				if (str_path == null) {
					return;
				}
				File f = new File(str_path);
				if (!f.exists()) {
					MessageBox.show(this, "路径:" + str_path + " 不存在!");
					return;
				}
				new SplashWindow(this, new AbstractAction() {
					public void actionPerformed(ActionEvent e) {
						ICheckUIUtil checkUtil = new ICheckUIUtil();
						for (int i = 0; i < vos.length; i++) {
							String schemeid = vos[i].getStringValue("schemeid");
							String deptid = vos[i].getStringValue("deptid");
							String deptname = vos[i].getStringViewValue("deptid");
							if (deptname != null) {
								if (deptname.contains("-")) {//全路径分隔号
									deptname = deptname.substring(deptname.lastIndexOf("-") + 1);
								}
							}
							boolean isexp = checkUtil.exportDataByCondition((SplashWindow) e.getSource(), str_path, schemeid, deptid, deptname, "", 0);
							if (isexp) {//如果导出成功，则更新检查实施主表导出状态【李春娟/2016-10-11】
								try {
									UIUtil.executeUpdateByDS(null, "update ck_scheme_impl set expstatus='已导出' where schemeid='" + schemeid + "' and deptid ='" + deptid + "'");
								} catch (WLTRemoteException e1) {
									e1.printStackTrace();
								} catch (Exception e1) {
									e1.printStackTrace();
								}
							}
						}
					}
				}, 600, 130, 300, 300, false); // 
			}
		}
	}

	/**
	 * 检查方案-导出Word 弹出框
	 * zzl
	 */
	private void onExpWord() {
		if (expWordPopMenu == null) {
			expWordPopMenu = new JPopupMenu(); //

			menu_notice = new JMenuItem("导出检查通知书");
			menu_interview = new JMenuItem("导出进驻会谈记录模板");
			menu_retrival = new JMenuItem("导出资料调阅清单");

			menu_notice.addActionListener(this);
			menu_interview.addActionListener(this);
			menu_retrival.addActionListener(this);

			expWordPopMenu.add(menu_notice);
			expWordPopMenu.add(menu_interview);
			expWordPopMenu.add(menu_retrival);
		}
		expWordPopMenu.show(btn_exp_word, btn_exp_word.getMousePosition().x, btn_exp_word.getMousePosition().y);
	}

	/**
	 * 检查方案-导出Word-导出检查通知书
	 * zzl
	 */
	private void impnotice() {
		BillListDialog listDialog = new BillListDialog(this, "请勾选需要导出的方案", "V_CK_SCHEME_IMPL_Q01", 950, 500);//网络版过滤相同的方案名和被检查机构【李春娟/2016-09-29】
		listDialog.getBilllistPanel().setRowNumberChecked(true);//设置勾选
		listDialog.getBilllistPanel().setDataFilterCustCondition("(teamusers like '%;" + loginUserid + ";%' or leader2='" + loginUserid + "' or leader ='" + loginUserid + "' or referee like '%;" + loginUserid + ";%')");
		listDialog.setVisible(true);
		if (listDialog.getCloseType() == 1) {//如果选择了记录，点击确定按钮
			final BillVO[] vos = listDialog.getBilllistPanel().getCheckedBillVOs();
			if (vos == null || vos.length == 0) {//一般情r，点击"确定"按钮后这里不为空
				MessageBox.show(this, "请至少勾选一个方案.");
				return;
			} else {
				JFileChooser chooser = new JFileChooser();
				chooser.setDialogTitle("请选择存放目录");
				chooser.setFileSelectionMode(JFileChooser.DIRECTORIES_ONLY);
				int flag = chooser.showSaveDialog(this);
				if (flag == 1 || chooser.getSelectedFile() == null) {
					return;
				}
				String str_path = chooser.getSelectedFile().getAbsolutePath(); //
				if (str_path == null) {
					return;
				}
				File f = new File(str_path + "\\检查通知书");
				f.mkdir();
				str_path = str_path + "\\检查通知书";
				if (!f.exists()) {
					MessageBox.show(this, "路径:" + str_path + " 不存在!");
					return;
				}
				Map<Object, Object> dataMap = new HashMap<Object, Object>();
				int a = 0;
				for (int i = 0; i < vos.length; i++) {
					a = a + 1;
					try {
						String id = UIUtil.getStringValueByDS(null, "select planid from CK_SCHEME where id='" + vos[i].getStringValue("schemeid") + "'");
						HashVO[] vo = UIUtil.getHashVoArrayByDS(null, "select * from CK_PLAN where id ='" + id + "'");
						String planName = UIUtil.getStringValueByDS(null, "select plantype from CK_plan where id='" + vos[i].getStringValue("planid") + "'");
						if (planName.equals("合规检查")) {
							planName = "合规";
						}
						if (planName.equals("审计检查")) {
							planName = "审计";
						}
						if (planName.equals("自律检查")) {
							planName = "自律";
						}
						dataMap.put("titel", planName);
						String year = vo[0].getStringValue("CREATEDATE");
						dataMap.put("code", year.substring(0, 4));
						String code2 = vo[0].getStringValue("CODE");
						code2 = code2 + "-" + a;
						dataMap.put("code2", code2);
						String deptname = UIUtil.getStringValueByDS(null, "select name from pub_corp_dept where id='" + vos[i].getStringValue("deptid") + "'");
						dataMap.put("dept", deptname);
						dataMap.put("planname", vos[i].getStringValue("planname"));
						dataMap.put("time", vo[0].getStringValue("PLANBEGINDATE"));
						String str1 = vo[0].getStringValue("PLANBEGINDATE");
						str1 = str1.replace("-", "");
						int PLANBEGINDATE = Integer.parseInt(str1);
						String str2 = vo[0].getStringValue("planenddate");
						str2 = str2.replace("-", "");
						int planenddate = Integer.parseInt(str2);
						dataMap.put("count", planenddate - PLANBEGINDATE);
						String[][] username = UIUtil.getStringArrayByDS(null, "select LEADER,REFEREE from CK_SCHEME where id='" + vos[i].getStringValue("schemeid") + "'");
						String LEADER = ZZLUIUtil.getUserName(username[0][0]);
						String REFEREE = ZZLUIUtil.getnamesSplit(username[0][1]);
						dataMap.put("LEADER", LEADER);
						dataMap.put("REFEREE", REFEREE);
						String teamusers = UIUtil.getStringValueByDS(null, "select teamusers from CK_plan where id ='" + vos[i].getStringValue("planid") + "'");
						teamusers = teamusers.replace(";", ",");
						teamusers = teamusers.substring(1, teamusers.length() - 1);
						String[] teamusersname = UIUtil.getStringArrayFirstColByDS(null, "select name from pub_user where id in(" + teamusers + ")");
						StringBuffer ckname = splitName(teamusersname);
						dataMap.put("TEAMUSERS", ckname);
						String str = str_path + "\\" + dataMap.get("dept") + "检查通知书.doc";
						WordExport mdoc = new WordExport();
						mdoc.createDoc(dataMap, "WordNotice", str);
					} catch (Exception e1) {
						e1.printStackTrace();
					}
				}
				MessageBox.show(this, "导出成功共导出" + vos.length + "个检查通知书");
			}
		}
	}

	private StringBuffer splitName(String[] name) {
		StringBuffer sbname = new StringBuffer();
		for (int i = 0; i < name.length; i++) {
			sbname.append(name[i].toString());
			sbname.append(",");
		}
		return sbname;
	}

	/**
	 * 检查方案-导出Word-导出进驻会谈记录模板
	 * zzl
	 */
	private void impinterview() {
		BillVO[] vos = implList.getBillVOs();
		if (vos.length <= 0) {
			MessageBox.show(null, "请选择一条数据");
			return;
		}
		JFileChooser chooser = new JFileChooser();
		chooser.setDialogTitle("请选择存放目录");
		chooser.setFileSelectionMode(JFileChooser.DIRECTORIES_ONLY);
		int flag = chooser.showSaveDialog(this);
		if (flag == 1 || chooser.getSelectedFile() == null) {
			return;
		}
		final String str_path = chooser.getSelectedFile().getAbsolutePath(); //
		if (str_path == null) {
			return;
		}
		File f = new File(str_path);
		if (!f.exists()) {
			MessageBox.show(this, "路径:" + str_path + " 不存在!");
			return;
		}
		Map<Object, Object> dataMap = new HashMap<Object, Object>();
		try {
			String planName = UIUtil.getStringValueByDS(null, "select plantype from CK_plan where id='" + vos[0].getStringValue("planid") + "'");
			if (planName.equals("合规检查")) {
				planName = "合规";
			}
			if (planName.equals("审计检查")) {
				planName = "审计";
			}
			if (planName.equals("自律检查")) {
				planName = "自律";
			}
			dataMap.put("titel", planName);
			String str = str_path + "\\" + dataMap.get("titel") + "检查进驻会谈记录.doc";
			WordExport mdoc = new WordExport();
			mdoc.createDoc(dataMap, "WordInterview", str);
			MessageBox.show(this, "导出成功");
		} catch (Exception e) {
			e.printStackTrace();
		}
	}

	/**
	 * 检查方案-导出Word-导出资料调阅清单
	 * zzl
	 */
	private void impRetrival() {
		BillListDialog listDialog = new BillListDialog(this, "请勾选需要导出的方案", "V_CK_SCHEME_IMPL_Q01", 950, 500);//网络版过滤相同的方案名和被检查机构【李春娟/2016-09-29】
		listDialog.getBilllistPanel().setRowNumberChecked(true);//设置勾选
		listDialog.getBilllistPanel().setDataFilterCustCondition("(teamusers like '%;" + loginUserid + ";%' or leader2='" + loginUserid + "' or leader ='" + loginUserid + "' or referee like '%;" + loginUserid + ";%')");
		listDialog.setVisible(true);
		final BillVO[] vos = listDialog.getBilllistPanel().getCheckedBillVOs();
		BillListDialog RetrivalDialog = new BillListDialog(this, "请填写要导出的资料", "CK_RETRIVAL_ZZl_EQ1", 900, 500);
		RetrivalDialog.setVisible(true);
		final BillVO[] Rvos = RetrivalDialog.getBilllistPanel().getBillVOs();
		StringBuilder sb = new StringBuilder();
		for (int i = 0; i < vos.length; i++) {
			sb.append(vos[i].getStringValue("deptid"));
			sb.append(",");
		}
		if (Rvos.length <= 0) {
			return;
		}
		for (int i = 0; i < Rvos.length; i++) {
			UpdateSQLBuilder update = new UpdateSQLBuilder("CK_RETRIVAL");
			update.setWhereCondition("id=" + Rvos[i].getStringValue("id"));
			System.out.println(">>>>>>>>>>>>>>>>>>>>" + vos[0].getStringValue("schemeid"));
			update.putFieldValue("schemeid", vos[0].getStringValue("schemeid"));
			update.putFieldValue("deptid", sb.toString());
			try {
				UIUtil.executeUpdateByDS(null, update.getSQL());
			} catch (Exception e) {
				e.printStackTrace();
			}
		}
		JFileChooser chooser = new JFileChooser();
		chooser.setDialogTitle("请选择存放目录");
		chooser.setFileSelectionMode(JFileChooser.DIRECTORIES_ONLY);
		int flag = chooser.showSaveDialog(this);
		if (flag == 1 || chooser.getSelectedFile() == null) {
			return;
		}
		String str_path = chooser.getSelectedFile().getAbsolutePath(); //
		if (str_path == null) {
			return;
		}
		File f = new File(str_path + "\\资料调阅清单");
		f.mkdir();
		str_path = str_path + "\\资料调阅清单";
		if (!f.exists()) {
			MessageBox.show(this, "路径:" + str_path + " 不存在!");
			return;
		}
		for (int i = 0; i < vos.length; i++) {
			String deptname;
			try {
				deptname = UIUtil.getStringValueByDS(null, "select name from pub_corp_dept where id='" + vos[i].getStringValue("deptid") + "'");
				HSSFWorkbook wb = new HSSFWorkbook();
				HSSFSheet sheet = wb.createSheet(deptname);
				HSSFCellStyle style = wb.createCellStyle(); // 样式对象     
				sheet.addMergedRegion(new Region(0, (short) 0, 0, (short) 5));
				sheet.addMergedRegion(new Region(1, (short) 0, 1, (short) 5));
				sheet.setColumnWidth(0, 3766);
				style.setVerticalAlignment(HSSFCellStyle.VERTICAL_CENTER);// 垂直      
				style.setAlignment(HSSFCellStyle.ALIGN_CENTER);// 水平     
				style.setBorderBottom(HSSFCellStyle.BORDER_THIN); //下边框
				style.setBorderLeft(HSSFCellStyle.BORDER_THIN);//左边框
				style.setBorderTop(HSSFCellStyle.BORDER_THIN);//上边框
				style.setBorderRight(HSSFCellStyle.BORDER_THIN);//右边框
				HSSFFont font = wb.createFont();
				font.setFontName("黑体");
				font.setFontHeightInPoints((short) 16);//设置字体大小     
				HSSFFont font2 = wb.createFont();
				font2.setFontName("仿宋_GB2312");
				font2.setBoldweight(HSSFFont.BOLDWEIGHT_BOLD);//粗体显示
				font2.setFontHeightInPoints((short) 12);
				style.setFont(font);//选择需要用到的字体格式
				HSSFRow row = sheet.createRow((short) 0);
				row.setHeight((short) 666);
				for (int j = 0; j <= 5; j++) {
					HSSFCell cell = row.createCell((short) j);
					cell.setCellValue("新疆昌吉农村商业银行股份有限公司现场检查调阅资料清单");
					cell.setCellStyle(style);
				}
				HSSFRow row1 = sheet.createRow((short) 1);
				row1.setHeight((short) 555);
				for (int j = 0; j <= 5; j++) {
					HSSFCell cell1 = row1.createCell((short) j);
					cell1.setCellValue("被检查单位:" + deptname);
					cell1.setCellStyle(style);
				}
				HSSFRow row2 = sheet.createRow((short) 2);
				row2.setHeight((short) 444);
				for (int j = 0; j <= 5; j++) {
					HSSFCell cell2 = row2.createCell((short) j);
					if (j == 0) {
						sheet.setColumnWidth((short) j, (short) 6000);
						cell2.setCellValue("调阅资料名称");
					} else if (j == 1) {
						sheet.setColumnWidth((short) j, (short) 1500);
						cell2.setCellValue("份数");
					} else if (j == 2) {
						sheet.setColumnWidth((short) j, (short) 4500);
						cell2.setCellValue("调阅时间");
					} else if (j == 3) {
						sheet.setColumnWidth((short) j, (short) 4500);
						cell2.setCellValue("调阅人签名");
					} else if (j == 4) {
						sheet.setColumnWidth((short) j, (short) 4500);
						cell2.setCellValue("交还日期");
					} else if (j == 5) {
						sheet.setColumnWidth((short) j, (short) 4500);
						cell2.setCellValue("收回人签名");
					}
					cell2.setCellStyle(style);
				}
				for (int j = 0; j < 4; j++) {
					int a = 2 + j;
					sheet.addMergedRegion(new Region(Rvos.length + 3 - Rvos.length, (short) a, Rvos.length + 3 - 1, (short) a));
				}

				for (int j = 0; j < Rvos.length; j++) {
					String schemeid = UIUtil.getStringValueByDS(null, "select schemeid from ck_retrival where id='" + Rvos[j].getStringValue("id") + "'");
					HSSFRow row3 = sheet.createRow((short) 3 + j);
					row3.setHeight((short) 444);
					HSSFCell cell3 = row3.createCell((short) 0);
					HSSFCell cell4 = row3.createCell((short) 1);
					cell3.setCellValue(Rvos[j].getStringValue("Profilename"));
					cell3.setCellStyle(style);
					cell4.setCellValue(Rvos[j].getStringValue("number"));
					cell4.setCellStyle(style);
					for (int k = 0; k < 4; k++) {
						HSSFRow row5 = sheet.getRow((short) Rvos.length + 3 - Rvos.length + j);
						HSSFCell cell5 = row5.createCell((short) k + 2);
						if (k == 0) {
							cell5.setCellValue("年 月 日");
						} else if (k == 1) {
							String[][] dept = UIUtil.getStringArrayByDS(null, "select leader,teamusers  from CK_MEMBER_WORK where schemeid='" + schemeid + "' and checkeddept like'%" + vos[i].getStringValue("deptid") + "%'");
							StringBuilder deptsb = new StringBuilder();
							String name = UIUtil.getStringValueByDS(null, "select name from pub_user where id in(" + dept[0][0] + ")");
							deptsb.append(name);
							deptsb.append(",");
							String deptid = dept[0][1].toString().replace(";", ",");
							deptid = deptid.substring(1, deptid.length() - 1);
							String[] username = UIUtil.getStringArrayFirstColByDS(null, "select name from pub_user where id in(" + deptid + ")");
							for (int q = 0; q < username.length; q++) {
								deptsb.append(username[q].toString());
								deptsb.append(",");
							}
							style.setWrapText(true);
							cell5.setCellValue(deptsb.toString());
						} else if (k == 2) {
							cell5.setCellValue("年 月 日");
						}

						cell5.setCellStyle(style);
					}
				}
				FileOutputStream fileOut;
				fileOut = new FileOutputStream(str_path + "\\" + deptname + "资料调阅清单.xls");
				wb.write(fileOut);
				fileOut.close();
			} catch (Exception e) {
				e.printStackTrace();
			}
		}
		MessageBox.show(null, "成功导出" + vos.length + "个资料查阅清单");
	}

	/**
	 * 
	 * 新增检查实施（拷贝当前检查底稿）
	 */
	private void onCopyImpl() {
		if (implList.getRowCount() == 0) {
			MessageBox.show(this, "请在左侧选中一个检查方案.");
			return;
		}
		BillVO billvo = implList.getBillVO(0);
		String id = billvo.getStringValue("id");
		try {
			BillCardDialog cardDialog = new BillCardDialog(this, "CK_WLTDUAL_LCJ_E01", WLTConstants.BILLDATAEDITSTATE_UPDATE);
			cardDialog.setTitle("");
			cardDialog.getBillcardPanel().setRealValueAt("c1", "1");
			cardDialog.getBtn_save().setVisible(false);
			cardDialog.setVisible(true);
			if (cardDialog.getCloseType() != 1) {
				return;
			}

			HashVOStruct hvst = UIUtil.getHashVoStructByDS(null, "select * from ck_scheme_impl where id =" + id);
			String[] str_keys = hvst.getHeaderName(); // 列名
			HashVO[] hvs = hvst.getHashVOs(); //
			ArrayList sqlList = new ArrayList();
			InsertSQLBuilder isql = new InsertSQLBuilder("ck_scheme_impl");
			if (hvs.length == 0) {
				MessageBox.show(this, "未查询到检查实施主表记录.");
				return;
			}

			HashVOStruct hvst2 = UIUtil.getHashVoStructByDS(null, "select * from ck_scheme_implement where implid =" + id);
			String[] str_keys2 = hvst2.getHeaderName(); // 列名
			HashVO[] hvs2 = hvst2.getHashVOs(); //
			InsertSQLBuilder isql2 = new InsertSQLBuilder("ck_scheme_implement");
			if (hvs2.length == 0) {
				MessageBox.show(this, "未查询到检查实施子表记录.");
				return;
			}

			String count = cardDialog.getBillVO().getStringValue("c1");
			int intcount = Integer.parseInt(count);
			if (intcount > 50) {
				intcount = 50;//最多50笔业务【李春娟/2016-10-08】
			}

			for (int i = 0; i < intcount; i++) { // 遍历各行!!
				//复制检查实施主表ck_scheme_impl
				for (int j = 0; j < str_keys.length; j++) { // 遍历各列!!
					String str_itemValue = hvs[0].getStringValue(str_keys[j], ""); // 取得值!!
					isql.putFieldValue(str_keys[j], str_itemValue);
				}
				String implid = UIUtil.getSequenceNextValByDS(null, "s_ck_scheme_impl");
				isql.putFieldValue("id", implid);
				for (int j2 = 1; j2 < 19; j2++) {
					isql.putFieldValue("c" + j2, "");//信贷台账
				}
				isql.putFieldValue("refc1", "");//信贷台账
				isql.putFieldValue("refimplid", "");//信贷台账
				isql.putFieldValue("status", "未执行");//状态

				isql.putFieldValue("createdate", TBUtil.getTBUtil().getCurrDate());//录入日期
				isql.putFieldValue("creater", loginUserid);//录入人
				isql.putFieldValue("createdept", ClientEnvironment.getInstance().getLoginUserDeptId());//录入机构
				sqlList.add(isql.getSQL());

				//复制检查实施子表ck_scheme_implement
				for (int j = 0; j < hvs2.length; j++) {
					for (int m = 0; m < str_keys2.length; m++) { // 遍历各列!!
						String str_itemValue = hvs2[j].getStringValue(str_keys2[m], ""); // 取得值!!
						isql2.putFieldValue(str_keys2[m], str_itemValue);
					}
					isql2.putFieldValue("id", UIUtil.getSequenceNextValByDS(null, "s_ck_scheme_implement"));
					isql2.putFieldValue("implid", implid);
					isql2.putFieldValue("control", "");//结果描述
					isql2.putFieldValue("result", "");//检查结果
					isql2.putFieldValue("descr", "");//附件
					sqlList.add(isql2.getSQL());
				}
			}
			UIUtil.executeBatchByDS(null, sqlList);
			MessageBox.show(this, "复制成功!");
			implList.refreshData();
			itemList.clearTable();
		} catch (WLTRemoteException e) {
			e.printStackTrace();
			MessageBox.showException(this, e);
		} catch (Exception e) {
			e.printStackTrace();
			MessageBox.showException(this, e);
		}
	}

	/**
	 * 检查实施-修改【李春娟/2016-09-29】
	 */
	private void onEditImpl() {
		if (implList.getRowCount() == 0) {
			MessageBox.show(this, "请在左侧选中一个检查方案.");
			return;
		}
		BillVO billVO = implList.getSelectedBillVO();
		BillCardPanel cardPanel = new BillCardPanel(implList.templetVO);
		cardPanel.setBillVO(billVO); //
		cardPanel.setRealValueAt("STATUS", "执行中");//状态
		cardPanel.setRealValueAt("createdate", TBUtil.getTBUtil().getCurrDate());//录入日期
		cardPanel.setRealValueAt("creater", loginUserid);//录入人
		cardPanel.setRealValueAt("createdept", ClientEnvironment.getInstance().getLoginUserDeptId());//录入机构
		BillCardDialog dialog = new BillCardDialog(implList, implList.templetVO.getTempletname(), cardPanel, WLTConstants.BILLDATAEDITSTATE_UPDATE);
		dialog.setVisible(true); //
		if (dialog.getCloseType() == 1) {
			implList.setBillVOAt(implList.getSelectedRow(), dialog.getBillVO(), false); //
			implList.setRowStatusAs(implList.getSelectedRow(), WLTConstants.BILLDATAEDITSTATE_INIT);
		}
	}

	/**
	 * 信贷检查或票据检查，关联客户
	 */
	private void onRelate() {
		BillVO billvo = implList.getSelectedBillVO();
		if (billvo == null) {
			MessageBox.show(this, "请选中一个检查实施.");
			return;
		}
		String id = billvo.getStringValue("id");
		String schemeid = billvo.getStringValue("schemeid");
		String deptid = billvo.getStringValue("deptid");
		BillListDialog listDialog = new BillListDialog(this, "请选择被关联的客户名称", "CK_SCHEME_IMPL_E02", "schemeid = '" + schemeid + "' and deptid = '" + deptid + "' and id !=" + id, 600, 500);
		listDialog.getBilllistPanel().setDataFilterCustCondition("schemeid = '" + schemeid + "' and deptid = '" + deptid + "' and id !=" + id);
		listDialog.setVisible(true);
		if (listDialog.getCloseType() == 1) {
			BillVO[] billvos = listDialog.getReturnBillVOs();
			if (billvos != null && billvos.length > 0) {
				try {
					String status = billvos[0].getStringValue("status");
					UIUtil.executeUpdateByDS(null, "update CK_SCHEME_IMPL set refimplid ='" + billvos[0].getStringValue("id") + "' ,refc1='" + billvos[0].getStringValue("c1", "") + "',status='" + status + "' where id =" + billvo.getStringValue("id"));
					implList.refreshCurrSelectedRow();
					if ("已结束".equals(status)) {
						btn_edit.setVisible(false);//检查实施-修改
						btn_insert.setVisible(false);//检查实施子表-逐条录入
						btn_end.setVisible(false);//检查实施子表-底稿录入完成
					} else {
						btn_edit.setVisible(true);
						btn_insert.setVisible(true);
						btn_end.setVisible(true);
					}
				} catch (WLTRemoteException e) {
					e.printStackTrace();
				} catch (Exception e) {
					e.printStackTrace();
				}
			}
		}
	}

	/**
	 * 检查实施子表-逐条录入
	 */
	public void onInsert() {
		if (itemList.getRowCount() == 0) {
			MessageBox.show(this, "请选中一个检查实施.");
			return;
		} else {
			BillVO vo = itemList.getSelectedBillVO();
			if (null == vo) {
				itemList.setSelectedRow(0);
			}
		}

		BillCardDialog_CheckIn dialog = new BillCardDialog_CheckIn(implList, itemList, childTempletCode, "检查工作底稿");
		dialog.setVisible(true);
	}

	/**
	 * 检查实施子表-检查评价指引
	 */
	private void onCheckHelp() {
		if (itemList.getSelectedBillVO() == null) {
			MessageBox.show(this, "请选择一个检查工作底稿!");
			return;
		}
		BillCardDialog dialog_card = new BillCardDialog(itemList, "CK_MANUSCRIPT_DESIGN_SCY_Q01", WLTConstants.BILLDATAEDITSTATE_UPDATE);
		dialog_card.setTitle("检查帮助提示");
		dialog_card.billcardPanel.queryDataByCondition(" id='" + itemList.getSelectedBillVO().getStringValue("id") + "'");
		dialog_card.getBtn_save().setVisible(false);
		dialog_card.getBtn_confirm().setVisible(false);
		dialog_card.setVisible(true);
	}

	/**
	 * 检查实施子表-底稿录入完成【李春娟/2016-10-09】
	 */
	private void onEnd() {
		if (itemList.getRowCount() == 0 || implList.getSelectedBillVO() == null) {
			MessageBox.show(this, "请选中一个检查实施.");
			return;
		}
		String status = implList.getSelectedBillVO().getStringValue("status");
		if ("已结束".equals(status)) {
			MessageBox.show(this, "该检查实施已结束.");
			return;
		}
		String msg = "底稿录入完成后不可修改，是否继续?";
		int rowCount = itemList.getRowCount();
		for (int i = 0; i < rowCount; i++) {
			String checkMode = itemList.getRealValueAtModel(i, "checkMode");//检查方式：现场检查、非现场检查
			if ("现场检查".equals(checkMode)) {//网络版需要判断是否有现场检查的记录【李春娟/2016-10-13】
				msg = "该底稿有现场检查的记录，录入完成后不可修改，是否继续?";
				break;
			}
		}
		if (MessageBox.confirm(this, msg)) {
			String implid = itemList.getRealValueAtModel(0, "implid");
			try {
				UIUtil.executeUpdateByDS(null, "update CK_SCHEME_IMPL set status='已结束' where id ='" + implid + "' or refimplid ='" + implid + "'");
				implList.refreshData();
				itemList.clearTable();
				btn_edit.setVisible(false);
				btn_insert.setVisible(false);
				btn_end.setVisible(false);
				MessageBox.show(this, "操作成功!");
			} catch (WLTRemoteException e) {
				e.printStackTrace();
			} catch (Exception e) {
				e.printStackTrace();
			}
		}
	}

	/**
	 * 问题删除逻辑，需要同时删掉违规事件及子表记录【李春娟/2016-09-07】
	 */
	private void onDeleteProblem() {
		BillListPanel listPanel = (BillListPanel) btn_deletePro.getBillPanelFrom();
		BillVO billvo = listPanel.getSelectedBillVO();
		if (billvo == null) {
			MessageBox.showSelectOne(listPanel);
			return;
		}
		if (!MessageBox.confirm(listPanel, "您确定要删除吗?")) {
			return;
		}
		String id = billvo.getStringValue("id");
		ArrayList sqlList = new ArrayList();
		sqlList.add("delete from ck_problem_info where id =" + id);
		sqlList.add("delete from cmp_wardevent_cust where cmp_wardevent_id in(select id from cmp_event where problemid =" + id + ")");
		sqlList.add("delete from cmp_wardevent_user where cmp_wardevent_id in(select id from cmp_event where problemid =" + id + ")");
		sqlList.add("delete from cmp_event where problemid =" + id);
		try {
			UIUtil.executeBatchByDS(null, sqlList);
			listPanel.removeSelectedRow();
		} catch (Exception e) {
			e.printStackTrace();
		}
	}

}
